nextflow_process {

    name "Test Process AZIMUTH"
    script "modules/local/azimuth/main.nf"
    process "AZIMUTH"

    test("Should run Azimuth mapping for PBMC") {

        when {
            // Move params inside the 'when' block
            params {
                atac = false
                copy_mode = "copy"
                // If the process uses these, define them here:
                remap_celltypes = false 
                mapping_file = ""
            }
            process {
                """
                input[0] = tuple("test_sample", file("tests/data/pbmc_tiny.h5ad"))
                input[1] = file("tests/data/mapping_v3.csv")
                input[2] = [ 
                    name: 'pbmc_ref', 
                    refset: 'PBMC', 
                    annotation_labels: 'celltype.l2' 
                ]
                """
            }
        }

        then {
            assert process.success
            assert process.out.celltype_tables_all[0].size() == 3
            assert path(process.out.versions[0]).exists()
            assert snapshot(process.out.predicted_celltype_labels).match()
        }
    }
}